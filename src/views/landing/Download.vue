<template>
    <section class="landing-main landing-download">
        <div class="landing-download-wrapper">
            <div class="landing-download-image">
                <svg t="1587887399265" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9282" xmlns:xlink="http://www.w3.org/1999/xlink" width="320" height="320"><path d="M1006.815669 477.629567h-51.174275v-119.413238c-0.053962-47.074937-38.207128-85.228102-85.291058-85.285662h-204.697101c-47.085729 0.05756-85.2317 38.210725-85.287461 85.285662v119.413238H370.889409l-22.736128-68.231767h146.921435c28.258273 0 51.170678-22.914204 51.170677-51.174276V51.174275C546.247192 22.916002 523.332988 0 495.072917 0H51.56373C23.296464 0 0.389455 22.912405 0.389455 51.174275v307.042054c0 28.267267 22.907009 51.174275 51.174275 51.174276h146.921435L175.745439 477.620573H17.44335c-9.414628 0-17.052096 7.637468-17.052096 17.06109v511.742753c0 9.421823 7.637468 17.059291 17.052096 17.05929h68.233566a17.059291 17.059291 0 0 0 17.059291-17.05929V579.976319h477.622372v51.172476h-76.756017c-32.97458 0-59.702122 26.72934-59.702122 59.702122s26.72934 59.703921 59.702122 59.703921h196.169255v122.012423l-86.810998 14.452911c-37.674699 0.836416-67.537452 32.060818-66.693841 69.737316 0.843611 37.674699 32.068013 67.528458 69.737317 66.692042 30.535483-0.679925 56.89788-21.570542 64.542543-51.143696h140.794911c7.813745 30.107382 34.962193 51.1383 66.067878 51.174275a67.445716 67.445716 0 0 0 35.546784-10.231258 17.052096 17.052096 0 0 0 15.627491 10.229459h68.231767a17.052096 17.052096 0 0 0 17.052096-17.052096v-511.742752c0.008994-9.416426-7.630273-17.052096-17.052096-17.052096z m-17.059291 34.113186v34.113185H955.641394V511.742753zM802.11677 750.554838h68.233566a84.397082 84.397082 0 0 0 51.174275-17.501782v163.466284a67.4691 67.4691 0 0 0-32.596844-9.499168l-86.810997-14.445716zM51.56373 34.113186H495.072917a17.059291 17.059291 0 0 1 17.061089 17.059291V307.045652H34.502641V51.174275a17.059291 17.059291 0 0 1 17.061089-17.059291z m-17.061089 324.103143v-17.052096h477.631365v17.052096a17.059291 17.059291 0 0 1-17.061089 17.06109H51.56373a17.059291 17.059291 0 0 1-17.061089-17.06109z m199.935825 51.174276h77.752521l22.736128 68.231767h-123.226576zM68.615826 989.37232H34.504439V579.976319h34.113186z m17.06109-443.516382h-51.174275V511.742753h545.855938v34.113185z m392.33671 144.996778c0-14.130935 11.458001-25.58354 25.588936-25.58354h93.817107a17.059291 17.059291 0 0 0 17.05929-17.06109V358.216329c0-28.258273 22.912405-51.172477 51.174276-51.172476h204.697101c28.258273 0 51.174275 22.912405 51.174275 51.174275v307.051048c0 28.258273-22.916002 51.172477-51.174275 51.172476h-366.745975c-14.130935 0-25.590735-11.4598-25.590735-25.590735z m409.396001 298.519604c-18.843645 0-34.118582-15.274937-34.118582-34.120381 0-9.421823-7.637468-17.059291-17.052096-17.059291h-170.587513c-9.421823 0-17.052096 7.637468-17.052096 17.059291 0 18.845444-15.274937 34.122179-34.120381 34.122179-18.838249 0-34.113186-15.276735-34.113185-34.122179 0-18.83645 15.274937-34.111387 34.113185-34.111387a15.494383 15.494383 0 0 0 2.797048-0.239233L719.628155 903.840229a17.057492 17.057492 0 0 0 14.256847-16.820057v-136.465334h34.120381v136.465334a17.052096 17.052096 0 0 0 14.255048 16.820057l102.353947 17.06109c0.919158 0.161887 1.852707 0.244629 2.795249 0.239233 18.838249 0 34.113186 15.274937 34.113185 34.111387 0 18.845444-15.274937 34.122179-34.113185 34.122179z m102.346751 0H955.641394V579.976319h34.113186z m0 0" p-id="9283" fill="#1faeff"></path><path d="M170.969773 1023.485505h170.578519a17.057492 17.057492 0 0 0 17.059291-15.845138l17.059291-238.810287c0.667334-9.402036-6.407127-17.559342-15.801969-18.226676a15.050094 15.050094 0 0 0-1.257322-0.048566h-204.697101c-9.42542-0.021585-17.07548 7.594298-17.104259 17.016121 0 0.422705 0.01439 0.836416 0.050364 1.259121l17.052096 238.810287A17.062888 17.062888 0 0 0 170.969773 1023.485505z m169.319398-238.812085l-14.621992 204.6989h-138.818091l-14.614798-204.697101z m0 0" p-id="9284" fill="#1faeff"></path></svg>
            </div>
            <div class="landing-download-op">
                <div class="landing-download-op-text">
                    <transition
                        mode="out-in"
                        enter-active-class="animated fadeIn faster"
                        leave-active-class="animated fadeOut faster"
                    >
                        <span key="unavaliable" v-if="versionStatus === 'unavaliable'"
                            >很遗憾...</span
                        >
                        <span key="default" v-else-if="!downloadStarted">即刻享用！</span>
                        <span key="thanks" v-else-if="downloadStarted">感谢您的下载！</span>
                    </transition>
                </div>
                <div class="landing-download-op-zone">
                    <div class="download-zone-version" v-if="versionStatus === 'unavaliable'">
                        <span>您的操作系统目前不受支持</span>
                    </div>
                    <div class="download-zone-version" v-else>
                        <span>当前版本:
                            <span style="margin-left: 12px">
                                {{versionText}}
                            </span>
                        </span>
                    </div>
                    <div
                        class="download-zone-button"
                        v-if="versionStatus !== 'unavaliable'"
                    >
                        <el-button
                            type="success"
                            :disabled="versionStatus !== 'resolved' || downloadLoading"
                            @click="mainDownload"
                            >下载</el-button>
                    </div>
                    <div class="download-zone-button" v-else>
                        <el-button disabled>下载</el-button>
                    </div>
                    <div class="download-zone-all">
                        <p>所有下载：</p>
                        <el-row>
                            <el-col :span="10"><span>Windows</span></el-col>
                            <el-col class="download-zone-all-link" :span="7"
                                ><span @click="download('win64')"
                                    >64 bit</span
                                ></el-col
                            >
                            <el-col class="download-zone-all-link" :span="7"
                                ><span @click="download('win32')"
                                    >32 bit</span
                                ></el-col
                            >
                        </el-row>
                        <el-row>
                            <el-col :span="10">macOS</el-col>
                            <el-col
                                class="download-zone-all-unavaliable"
                                :span="7"
                                ><span>暂无</span></el-col
                            >
                            <el-col
                                class="download-zone-all-unavaliable"
                                :span="7"
                                ><span>暂无</span></el-col
                            >
                        </el-row>
                        <el-row>
                            <el-col :span="10">Linux</el-col>
                            <el-col
                                class="download-zone-all-unavaliable"
                                :span="7"
                                ><span>暂无</span></el-col
                            >
                            <el-col
                                class="download-zone-all-unavaliable"
                                :span="7"
                                ><span>暂无</span></el-col
                            >
                        </el-row>
                    </div>
                </div>
            </div>
        </div>
    </section>
</template>

<script>
const downloadBase = "http://update.backrunner.top/fastnote";

export default {
    name: "Landing.Download",
    data() {
        return {
            // vars
            downloadURL: null,
            downloadStarted: false,
            // flag
            downloadLoading: false
        };
    },
    computed: {
        versionStatus() {
            console.log(this.$store.state.client.status);
            return this.$store.state.client.status;
        },
        versionText() {
            switch(this.$store.state.client.status) {
                case 'fetching':
                    return '获取中';
                case 'resolved':
                    if (this.$store.state.client.version) {
                        return this.$store.state.client.version;
                    } else {
                        this.$store.commit('client/setStatus', 'failed');
                        break;
                    }
                case 'failed':
                    return '获取失败';

            }
        },
        version() {
            return this.$store.state.client.version;
        }
    },
    methods: {
        mainDownload() {
            if (window.os.isWin) {
                if (window.os.isOS64bit) {
                    this.downloadURL = `${downloadBase}/win32/x64/Fastnote Setup ${this.version}.exe`;
                } else {
                    this.downloadURL = `${downloadBase}/win32/Fastnote Setup ${this.version}.exe`;
                }
            }
            this.downloadLoading = true;
            this.downloadStarted = true;
            setTimeout(() => {
                this.startDownload();
            }, 2000);
            setTimeout(() => {
                this.downloadLoading = false;
                const iframe = document.getElementById('iframe-download');
                if (iframe) iframe.parentNode.removeChild(iframe);
            }, 5000);
        },
        download(version) {
            switch (version) {
                case "win32":
                    this.downloadURL = `${downloadBase}/win32/Fastnote Setup ${this.version}.exe`;
                    break;
                case "win64":
                    this.downloadURL = `${downloadBase}/win32/x64/Fastnote Setup ${this.version}.exe`;
                    break;
            }
            this.startDownload();
        },
        startDownload() {
            const iframe = document.createElement('iframe');
            iframe.setAttribute('id', 'iframe-download');
            iframe.setAttribute('src', this.downloadURL);
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
        }
    }
};
</script>